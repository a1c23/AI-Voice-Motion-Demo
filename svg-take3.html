<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Take 3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      height: 100vh;
      background: #f0f0f0;
      font-family: 'Inter', sans-serif;
    }

    .stage {
      position: relative;
      height: 100%;
    }

    /* Layer wrapper */
    .layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Layer stacking */
    .layer-bottom { z-index: 1; }
    .layer-mid { 
      z-index: 2;
      /* scale: 0.99; */
     }
    .layer-top { z-index: 3; }

    /* Rotation is handled by JavaScript for smooth speed changes */

    @keyframes rotateClockwise {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @keyframes rotateCounterClockwise {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(-360deg); }
    }

    /* Base circle styles */
    .circle {
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
    }

    /* Crossfade circles */
    .circle-a, .circle-b {
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transition: opacity 0.5s ease;
    }

    .circle-a { opacity: 1; }
    .circle-b { opacity: 0; }

    /* Base blur styles */
    .blur {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 1200px;
      height: 1200px;
      border-radius: 50%;

      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);

      /* must have some fill for consistent rendering */
      background: rgba(255,255,255,0.01);
      pointer-events: none;

      /* progressive blur: top = strong, bottom = none */
      -webkit-mask-image: linear-gradient(to bottom, black 0%, black 45%, rgba(0,0,0,0.25) 60%, transparent 100%);
      mask-image: linear-gradient(to bottom, black 0%, black 45%, rgba(0,0,0,0.25) 60%, transparent 100%);

      /* hide the rectangle boundary completely */
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
    }

    /* Bottom layer */
    .layer-bottom .circle-a,
    .layer-bottom .circle-b {
      width: 300px;
      height: 300px;
    }

    /* Middle layer */
    .layer-mid .circle-a,
    .layer-mid .circle-b {
      width: 300px;
      height: 300px;
    }

    /* Top layer - white, smaller */
    .layer-top .circle {
      width: 220px;
      height: 220px;
      background: white;
    }
    .layer-top .blur {
      width: 900px;
      height: 900px;
    }

    /* Controls */
    .controls {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
    }

    .theme-picker {
      display: flex;
      gap: 8px;
    }

    .theme-btn {
      width: 48px;
      height: 48px;
      border: 3px solid transparent;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
      overflow: hidden;
    }

    .theme-btn:hover {
      transform: scale(1.1);
    }

    .theme-btn.active {
      border-color: rgba(255,255,255,0.8);
    }

    /* Theme swatch colors */
    .theme-btn[data-theme="green"] {
      background: linear-gradient(90deg, #62D84E 50%, #4DFEEA 50%);
    }

    .theme-btn[data-theme="purple"] {
      background: linear-gradient(90deg, #C77DFF 50%, #7B2CBF 50%);
    }

    .theme-btn[data-theme="custom"] {
      background: linear-gradient(90deg, #FF8800 50%, #CC4400 50%);
    }

    /* Custom theme button wrapper with edit icon */
    .theme-btn-wrapper {
      position: relative;
    }

    .edit-icon {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }

    .edit-icon:hover {
      transform: scale(1.1);
    }

    .edit-icon svg {
      width: 10px;
      height: 10px;
    }

    /* Custom Theme Editor */
    .custom-theme-editor {
      position: fixed;
      bottom: 130px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 16px 20px;
      padding-top: 32px;
      border-radius: 12px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 100;
    }

    .editor-close {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s;
      padding: 0;
    }

    .editor-close:hover {
      opacity: 1;
    }

    .editor-close svg {
      width: 100%;
      height: 100%;
    }

    .custom-theme-editor.visible {
      opacity: 1;
      visibility: visible;
    }

    .editor-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .editor-row:last-child {
      margin-bottom: 0;
    }

    .row-label {
      width: 60px;
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .editor-row input {
      width: 100px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    .editor-row input:focus {
      outline: none;
      border-color: #999;
    }

    /* Waveform styles */
    .voice-waveform {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .row {
      display: flex;
      gap: 7px;
      align-items: center;
      justify-content: center;
    }

    .square-wrapper {
      width: 7px;
      height: 100px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .square {
      width: 7px;
      height: 7px;
      background: linear-gradient(to top, var(--color-1, #62D84E), var(--color-2, #4DD5FE));
      border-radius: 70px;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      transition: height 0.05s cubic-bezier(0.16, 1.0, 0.3, 1.0),
                  width 0.05s cubic-bezier(0.16, 1.0, 0.3, 1.0),
                  background 0.3s ease;
    }

    /* State toggles */
    .state-toggles {
      position: absolute;
      bottom: 280px;
      left: 50%;
      transform: translate(-50%, calc(-50% + 120px));
      z-index: 20;
      display: flex;
      gap: 12px;
    }

    .state-btn {
      width: 40px;
      height: 40px;
      padding: 8px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s, background 0.2s;
      color: #333;
    }

    .state-btn:hover {
      opacity: 0.7;
    }

    .state-btn.active {
      opacity: 1;
      background: rgba(255,255,255,0.5);
    }

    .state-btn svg {
      width: 100%;
      height: 100%;
    }

    /* Speed Slider */
    .speed-slider {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .speed-slider label {
      font-size: 11px;
      color: #555;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .speed-slider input[type="range"] {
      width: 120px;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(0,0,0,0.2);
      border-radius: 2px;
      outline: none;
    }

    .speed-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #555;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Responsive breakpoints */
    @media (max-width: 1200px) {
      .layer-bottom .circle-a,
      .layer-bottom .circle-b,
      .layer-mid .circle-a,
      .layer-mid .circle-b {
        width: 320px;
        height: 320px;
      }
      .layer-top .circle {
        width: 200px;
        height: 200px;
      }
      .blur {
        width: 900px;
        height: 900px;
      }
      .layer-top .blur {
        width: 700px;
        height: 700px;
      }
    }

    @media (max-width: 900px) {
      .layer-bottom .circle-a,
      .layer-bottom .circle-b,
      .layer-mid .circle-a,
      .layer-mid .circle-b {
        width: 260px;
        height: 260px;
      }
      .layer-top .circle {
        width: 160px;
        height: 160px;
      }
      .blur {
        width: 700px;
        height: 700px;
      }
      .layer-top .blur {
        width: 550px;
        height: 550px;
      }
    }

    @media (max-width: 600px) {
      .layer-bottom .circle-a,
      .layer-bottom .circle-b,
      .layer-mid .circle-a,
      .layer-mid .circle-b {
        width: 180px;
        height: 180px;
      }
      .layer-top .circle {
        width: 110px;
        height: 110px;
      }
      .blur {
        width: 500px;
        height: 500px;
      }
      .layer-top .blur {
        width: 400px;
        height: 400px;
      }
      .theme-btn {
        width: 40px;
        height: 40px;
      }
      .speed-slider input[type="range"] {
        width: 100px;
      }
    }

  </style>
</head>
<body>
  <div class="stage">
    <!-- Bottom layer -->
    <div class="layer layer-bottom">
      <div class="circle-a"></div>
      <div class="circle-b"></div>
      <div class="blur"></div>
    </div>

    <!-- Middle layer -->
    <div class="layer layer-mid">
      <div class="circle-a"></div>
      <div class="circle-b"></div>
      <div class="blur"></div>
    </div>

    <!-- Top layer (white, smaller) -->
    <div class="layer layer-top">
      <div class="circle"></div>
      <div class="blur"></div>
    </div>
  </div>

  <!-- Voice waveform animation -->
  <div class="voice-waveform" id="voice-waveform">
    <div class="row" id="wave-row"></div>
  </div>

  <!-- State toggles -->
  <div class="state-toggles">
    <button class="state-btn" data-state="ai-speaking" title="AI Speaking">
      <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M23.4641 4.45279C23.1743 5.41873 22.4186 6.17444 21.4527 6.46423L19.2451 7.12651C18.8745 7.23768 18.8745 7.76244 19.2451 7.87361L21.4527 8.53587C22.4186 8.82565 23.1743 9.58137 23.4641 10.5473L24.1266 12.7557C24.2378 13.1262 24.7624 13.1263 24.8737 12.7558L25.5375 10.5463C25.8274 9.58091 26.5828 8.82571 27.5483 8.53596L29.7551 7.87367C30.1256 7.76247 30.1256 7.23775 29.755 7.12658L27.5472 6.46423C26.5813 6.17444 25.8256 5.41873 25.5358 4.45279L24.8735 2.24522C24.7623 1.87464 24.2376 1.87464 24.1264 2.24522L23.4641 4.45279Z" fill="currentColor"/>
        <path d="M11.4344 11.8692C10.7472 14.0437 9.04377 15.7472 6.86927 16.4344L2.50425 17.8139C1.83369 18.0258 1.83349 18.9747 2.50396 19.1869L6.87211 20.5694C9.045 21.2572 10.747 22.9597 11.4341 25.1328L12.814 29.4968C13.026 30.1672 13.9746 30.1674 14.1869 29.497L15.5698 25.1299C16.2574 22.9585 17.9585 21.2573 20.13 20.5697L24.4971 19.1868C25.1674 18.9746 25.1672 18.0259 24.4968 17.8139L20.1328 16.4341C17.9597 15.747 16.2572 14.045 15.5695 11.8721L14.1869 7.50393C13.9747 6.83346 13.0259 6.83366 12.8139 7.50422L11.4344 11.8692Z" fill="currentColor"/>
      </svg>
    </button>
    <button class="state-btn" data-state="user-speaking" title="User Speaking">
      <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 19C21.8313 19 25.2026 21.0398 26.7627 22.3564C27.6726 23.1245 28 24.2409 28 25.25C28 27.8734 25.8734 30 23.25 30H8.75C6.12665 30 4 27.8734 4 25.25C4 24.2409 4.32737 23.1245 5.2373 22.3564C6.79739 21.0398 10.1687 19 16 19Z" fill="currentColor"/>
        <path d="M16 2C20.1421 2 23.5 5.35786 23.5 9.5C23.5 13.6421 20.1421 17 16 17C11.8579 17 8.5 13.6421 8.5 9.5C8.5 5.35786 11.8579 2 16 2Z" fill="currentColor"/>
      </svg>
    </button>
    <button class="state-btn active" data-state="system-at-rest" title="Rest">
      <svg width="24" height="24" viewBox="0 0 31 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.8629 3.93457C23.3471 4.09889 28.5532 9.40689 28.5533 15.9307C28.5531 21.904 24.1883 26.8561 18.4742 27.7754C17.7249 27.9219 16.9509 28 16.1588 28C11.7958 27.9999 7.98107 25.6694 5.88239 22.1924C5.22972 21.111 6.14995 20.0298 7.12067 20.002C7.26086 19.9568 7.40645 19.9307 7.55329 19.9307L7.96539 19.9209C8.21975 19.908 8.47078 19.8818 8.71832 19.8457C12.3898 19.1197 15.1588 15.8833 15.1588 11.999C15.1586 10.2513 14.5992 8.63748 13.649 7.32227C13.2305 6.74305 13.1312 6.01295 13.3287 5.38672C13.5344 4.73486 14.0896 4.14902 14.9351 4.0625L14.9966 4.05664C15.102 4.02682 15.2131 4.00512 15.3297 3.99316L15.6324 3.96582C15.9362 3.94246 16.2436 3.93068 16.5533 3.93066L16.8629 3.93457Z" fill="currentColor"/>
      </svg>
    </button>
    <button class="state-btn" data-state="system-thinking" title="Thinking">
      <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20.8662 26.9922C20.8468 27.0531 20.8262 27.114 20.8008 27.1738C20.5828 27.6864 20.1671 28.0603 19.7744 28.4385L19.3154 28.8809C18.9423 29.2401 18.5717 29.6201 18.0801 29.8184C17.7114 29.967 17.3212 29.9954 16.9307 30H15.1162C14.7328 29.9956 14.3494 29.9687 13.9863 29.8252C13.5024 29.6339 13.1345 29.2664 12.7637 28.9189L12.2646 28.4521C11.8597 28.0728 11.4314 27.6976 11.2061 27.1777C11.1807 27.1192 11.1592 27.0597 11.1396 27H20.75C20.7894 27 20.828 26.9966 20.8662 26.9922ZM21.1211 22.0635C21.0113 22.4217 21 22.8846 21 24.2529V25.0322C20.92 25.0116 20.8364 25 20.75 25H11V24.2529C11 22.8846 10.9887 22.4217 10.8789 22.0635C10.8789 22.0635 10.8702 22.0428 10.8506 22H21.1494C21.1298 22.0428 21.1211 22.0635 21.1211 22.0635ZM16 2C21.4932 2 26 6.32425 26 11.7236C26 13.6955 25.3955 15.5313 24.3594 17.0625C23.5453 18.2654 22.8942 19.2343 22.3867 20H9.61328C9.1058 19.2343 8.4547 18.2654 7.64062 17.0625C6.6045 15.5313 6 13.6955 6 11.7236C6.00003 6.32425 10.5068 2 16 2Z" fill="currentColor"/>
      </svg>
    </button>
  </div>

  <!-- Theme Picker -->
  <div class="controls">
    <div class="theme-picker">
      <button class="theme-btn active" data-theme="green" title="Green"></button>
      <button class="theme-btn" data-theme="purple" title="Purple"></button>
      <div class="theme-btn-wrapper">
        <button class="theme-btn" data-theme="custom" title="Custom"></button>
        <span class="edit-icon" id="edit-custom-theme" title="Edit colors">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </span>
      </div>
    </div>
    <div class="speed-slider">
      <label>Speed</label>
      <input type="range" id="speed-slider" min="6" max="24" value="12" step="1">
    </div>
  </div>

  <!-- Custom Theme Editor (hidden by default) -->
  <div class="custom-theme-editor" id="custom-editor">
    <button class="editor-close" id="editor-close" title="Close">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <div class="editor-row">
      <span class="row-label">AI BOT</span>
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="bottom" data-stop="0">
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="bottom" data-stop="1">
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="bottom" data-stop="2">
    </div>
    <div class="editor-row">
      <span class="row-label">AI MID</span>
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="mid" data-stop="0">
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="mid" data-stop="1">
      <input type="text" placeholder="#hex" data-mode="ai" data-layer="mid" data-stop="2">
    </div>
    <div class="editor-row">
      <span class="row-label">USR BOT</span>
      <input type="text" placeholder="#hex" data-mode="user" data-layer="bottom" data-stop="0">
      <input type="text" placeholder="#hex" data-mode="user" data-layer="bottom" data-stop="1">
      <input type="text" placeholder="#hex" data-mode="user" data-layer="bottom" data-stop="2">
    </div>
    <div class="editor-row">
      <span class="row-label">USR MID</span>
      <input type="text" placeholder="#hex" data-mode="user" data-layer="mid" data-stop="0">
      <input type="text" placeholder="#hex" data-mode="user" data-layer="mid" data-stop="1">
      <input type="text" placeholder="#hex" data-mode="user" data-layer="mid" data-stop="2">
    </div>
  </div>

  <script>
    const themes = {
      green: {
        ai: {
          bottom: ['#DEFE3C', '#62D84E', '#4DFEEA'],
          mid: ['#DEFE3C', '#62D84E', '#4DD5FE'],
          waveform: { start: [98, 216, 78], end: [77, 213, 254] }
        },
        user: {
          bottom: ['#A7FBFA', '#8CD2DA', '#6C84DD'],
          mid: ['#B6FDF8', '#5FC5D7', '#614FEE'],
          waveform: { start: [95, 197, 215], end: [97, 79, 238] }
        }
      },
      purple: {
        ai: {
          bottom: ['#E0AAFF', '#C77DFF', '#7B2CBF'],
          mid: ['#F0BAFF', '#D78DFF', '#8B3CCF'],
          waveform: { start: [199, 125, 255], end: [123, 44, 191] }
        },
        user: {
          bottom: ['#A8D0FF', '#7BA3E0', '#5B6BC0'],
          mid: ['#B8E0FF', '#8BB3F0', '#6B7BD0'],
          waveform: { start: [139, 179, 240], end: [91, 107, 192] }
        }
      },
      custom: {
        ai: {
          bottom: ['#FF5500', '#FF8800', '#FFBB00'],
          mid: ['#FF6611', '#FF9911', '#FFCC11'],
          waveform: { start: [255, 136, 0], end: [255, 187, 0] }
        },
        user: {
          bottom: ['#CC4400', '#CC6600', '#CC8800'],
          mid: ['#DD5511', '#DD7711', '#DD9911'],
          waveform: { start: [204, 102, 0], end: [204, 136, 0] }
        }
      }
    };

    let currentTheme = 'green';
    let activeLayer = 'a'; // Track which layer is visible
    let animationState = 'system-at-rest';

    // Waveform transition tracking
    let isTransitioning = false;
    let transitionStartTime = 0;
    const transitionDuration = 500;
    let previousHeights = [];

    // Color utility functions
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => {
        const hex = Math.round(Math.min(255, Math.max(0, x))).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    function darkenColor(hex, percent) {
      const rgb = hexToRgb(hex);
      if (!rgb) return hex;
      const factor = 1 - percent;
      return rgbToHex(
        Math.round(rgb.r * factor),
        Math.round(rgb.g * factor),
        Math.round(rgb.b * factor)
      );
    }

    // Helper to get color set based on state
    function getColorSet(state) {
      return (state === 'user-speaking') ? 'user' : 'ai';
    }

    // Set animation state with crossfade
    function setAnimationState(state) {
      if (animationState === state) return;

      // Trigger waveform transition
      isTransitioning = true;
      transitionStartTime = Date.now();
      // Store current heights for smooth transition
      squares.forEach((el, i) => {
        previousHeights[i] = parseFloat(el.style.height) || minHeights[i] || 10;
      });

      animationState = state;

      // Update button states
      document.querySelectorAll('.state-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.state === state);
      });

      // Crossfade to new colors
      const newActive = activeLayer === 'a' ? 'b' : 'a';
      const colorSet = getColorSet(state);
      const theme = themes[currentTheme][colorSet];

      // Set new colors on incoming layer
      const bottomNew = document.querySelector(`.layer-bottom .circle-${newActive}`);
      const midNew = document.querySelector(`.layer-mid .circle-${newActive}`);
      bottomNew.style.background = `linear-gradient(135deg, ${theme.bottom[0]} 0%, ${theme.bottom[1]} 50%, ${theme.bottom[2]} 100%)`;
      midNew.style.background = `linear-gradient(35deg, ${theme.mid[0]} 0%, ${theme.mid[1]} 54%, ${theme.mid[2]} 100%)`;

      // Crossfade
      document.querySelectorAll('.circle-a').forEach(el => {
        el.style.opacity = newActive === 'a' ? '1' : '0';
      });
      document.querySelectorAll('.circle-b').forEach(el => {
        el.style.opacity = newActive === 'b' ? '1' : '0';
      });

      activeLayer = newActive;
    }

    function setTheme(name) {
      currentTheme = name;

      // Toggle which layer is active for crossfade
      const newActive = activeLayer === 'a' ? 'b' : 'a';

      // Get colors based on current state
      const colorSet = getColorSet(animationState);
      const theme = themes[name][colorSet];

      // Set new gradients on the incoming layer
      const bottomNew = document.querySelector(`.layer-bottom .circle-${newActive}`);
      const midNew = document.querySelector(`.layer-mid .circle-${newActive}`);

      bottomNew.style.background = `linear-gradient(135deg, ${theme.bottom[0]} 0%, ${theme.bottom[1]} 50%, ${theme.bottom[2]} 100%)`;
      midNew.style.background = `linear-gradient(35deg, ${theme.mid[0]} 0%, ${theme.mid[1]} 54%, ${theme.mid[2]} 100%)`;

      // Crossfade: fade in new, fade out old
      document.querySelectorAll('.circle-a').forEach(el => {
        el.style.opacity = newActive === 'a' ? '1' : '0';
      });
      document.querySelectorAll('.circle-b').forEach(el => {
        el.style.opacity = newActive === 'b' ? '1' : '0';
      });

      activeLayer = newActive;

      // Update button states
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === name);
      });

      // Hide editor when switching away from custom theme
      if (name !== 'custom') {
        document.getElementById('custom-editor').classList.remove('visible');
      }
    }

    function populateCustomInputs() {
      document.querySelectorAll('.custom-theme-editor input').forEach(input => {
        const mode = input.dataset.mode; // 'ai' or 'user'
        const layer = input.dataset.layer;
        const stop = input.dataset.stop;
        input.value = themes.custom[mode][layer][stop];
      });
    }

    function handleCustomInput(input) {
      const mode = input.dataset.mode;
      const layer = input.dataset.layer;
      const stop = parseInt(input.dataset.stop);
      let value = input.value.trim();

      if (!value.startsWith('#')) value = '#' + value;

      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        themes.custom[mode][layer][stop] = value;
        if (currentTheme === 'custom') {
          // Refresh display based on current state
          const colorSet = getColorSet(animationState);
          const theme = themes.custom[colorSet];
          const activeCircleBottom = document.querySelector(`.layer-bottom .circle-${activeLayer}`);
          const activeCircleMid = document.querySelector(`.layer-mid .circle-${activeLayer}`);
          activeCircleBottom.style.background = `linear-gradient(135deg, ${theme.bottom[0]} 0%, ${theme.bottom[1]} 50%, ${theme.bottom[2]} 100%)`;
          activeCircleMid.style.background = `linear-gradient(35deg, ${theme.mid[0]} 0%, ${theme.mid[1]} 54%, ${theme.mid[2]} 100%)`;
        }
      }
    }

    // Init - set initial theme on circle-a
    function init() {
      const theme = themes.green.ai; // Start with AI colors
      document.querySelector('.layer-bottom .circle-a').style.background =
        `linear-gradient(135deg, ${theme.bottom[0]} 0%, ${theme.bottom[1]} 50%, ${theme.bottom[2]} 100%)`;
      document.querySelector('.layer-mid .circle-a').style.background =
        `linear-gradient(35deg, ${theme.mid[0]} 0%, ${theme.mid[1]} 54%, ${theme.mid[2]} 100%)`;
    }

    init();

    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => setTheme(btn.dataset.theme));
    });

    document.querySelectorAll('.state-btn').forEach(btn => {
      btn.addEventListener('click', () => setAnimationState(btn.dataset.state));
    });

    document.querySelectorAll('.custom-theme-editor input').forEach(input => {
      input.addEventListener('input', () => handleCustomInput(input));
    });

    // Close button for custom editor
    document.getElementById('editor-close').addEventListener('click', () => {
      document.getElementById('custom-editor').classList.remove('visible');
    });

    // Edit icon opens custom theme editor
    document.getElementById('edit-custom-theme').addEventListener('click', (e) => {
      e.stopPropagation(); // Don't trigger theme button click
      setTheme('custom'); // Switch to custom theme
      populateCustomInputs();
      document.getElementById('custom-editor').classList.add('visible');
    });

    // Rotation animation (JS-based for smooth speed changes)
    let rotationAngle = 0;
    let rotationSpeed = 360 / 12; // degrees per second (12s = full rotation)
    let lastRotationTime = performance.now();

    // Cache element references for performance
    const bottomRotateEls = document.querySelectorAll('.layer-bottom .circle-a, .layer-bottom .circle-b, .layer-bottom .blur');
    const midRotateEls = document.querySelectorAll('.layer-mid .circle-a, .layer-mid .circle-b, .layer-mid .blur');
    const topRotateEls = document.querySelectorAll('.layer-top .circle, .layer-top .blur');

    function animateRotation() {
      const now = performance.now();
      const delta = (now - lastRotationTime) / 1000; // seconds
      lastRotationTime = now;

      rotationAngle += rotationSpeed * delta;
      if (rotationAngle >= 360) rotationAngle -= 360;

      // Apply rotation to layers (bottom/top counter-clockwise, mid clockwise)
      bottomRotateEls.forEach(el => {
        el.style.transform = `translate(-50%, -50%) rotate(${-rotationAngle}deg)`;
      });
      midRotateEls.forEach(el => {
        el.style.transform = `translate(-50%, -50%) rotate(${rotationAngle}deg)`;
      });
      topRotateEls.forEach(el => {
        el.style.transform = `translate(-50%, -50%) rotate(${-rotationAngle}deg)`;
      });

      requestAnimationFrame(animateRotation);
    }

    animateRotation();

    // Speed slider
    document.getElementById('speed-slider').addEventListener('input', (e) => {
      // Slider goes 6-24, invert so left=slow(24s), right=fast(6s)
      const duration = 30 - parseInt(e.target.value);
      rotationSpeed = 360 / duration; // degrees per second
    });

    // Waveform animation
    const maxHeight = 100;
    const numSquares = 5;
    const centerIndex = Math.floor(numSquares / 2);
    const delayFrames = 3.0;
    const row = document.getElementById('wave-row');
    const squares = [];

    // Oval-shaped minHeight setup
    const baseMinHeight = 10;
    const centerBoost = 2.8;
    const minHeights = [];

    for (let i = 0; i < numSquares; i++) {
      const distance = Math.abs(i - centerIndex);
      const factor = 1 - (distance / centerIndex);
      const boosted = baseMinHeight + factor * baseMinHeight * (centerBoost - 1);
      minHeights.push(boosted);
    }

    // Create waveform squares
    function createWaveformSquares() {
      row.innerHTML = '';
      squares.length = 0;
      previousHeights = new Array(numSquares).fill(0);

      for (let i = 0; i < numSquares; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'square-wrapper';

        const square = document.createElement('div');
        square.className = 'square';

        wrapper.appendChild(square);
        row.appendChild(wrapper);
        squares.push(square);
        previousHeights[i] = minHeights[i];
      }
    }

    // Audio visualization
    const trailLength = numSquares * delayFrames;
    const heightHistory = new Array(trailLength).fill(0);
    let currentSmoothedValue = 0;

    function animateVoice() {
      // Generate waveform data based on state
      let targetValue = 0;

      if (animationState === 'system-at-rest') {
        // Decay to rest
        for (let i = 0; i < heightHistory.length; i++) {
          heightHistory[i] *= 0.85;
        }
        currentSmoothedValue *= 0.9;
      } else if (animationState === 'ai-speaking') {
        targetValue = 0.3 + Math.sin(Date.now() / 500) * 0.2 + Math.random() * 0.1;
      } else if (animationState === 'user-speaking') {
        targetValue = 0.25 + Math.sin(Date.now() / 400) * 0.15 + Math.random() * 0.1;
      }
      // system-thinking uses fixed height, handled in loop

      // Smooth the transition (except for rest state which decays)
      if (animationState !== 'system-at-rest') {
        const smoothingFactor = 0.15;
        currentSmoothedValue = currentSmoothedValue + (targetValue - currentSmoothedValue) * smoothingFactor;
      }

      heightHistory.unshift(currentSmoothedValue);
      heightHistory.pop();

      // Get current theme waveform colors based on state
      const colorSet = getColorSet(animationState);
      const waveStart = [...themes[currentTheme][colorSet].waveform.start];
      const waveEnd = [...themes[currentTheme][colorSet].waveform.end];

      // Animate center-outward
      const centerOutOrder = [2, 1, 3, 0, 4];
      centerOutOrder.forEach((index, i) => {
        const el = squares[index];
        if (!el) return;

        const curvedValue = heightHistory[i * delayFrames];
        const localMin = minHeights[index];

        // Calculate target height based on state
        let targetHeight;
        if (animationState === 'system-thinking') {
          targetHeight = 30; // Fixed medium height for thinking mode
        } else {
          targetHeight = localMin + curvedValue * (maxHeight - localMin);
        }

        // Interpolate during transition for smooth height changes
        let finalHeight = targetHeight;
        if (isTransitioning) {
          const elapsed = Date.now() - transitionStartTime;
          const progress = Math.min(elapsed / transitionDuration, 1);
          const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
          const prevHeight = previousHeights[index] || localMin;
          finalHeight = prevHeight + (targetHeight - prevHeight) * eased;
          if (progress >= 1) {
            isTransitioning = false;
          }
        }

        el.style.height = `${finalHeight}px`;
        el.style.width = '7px';

        const normalized = (targetHeight - localMin) / (maxHeight - localMin);

        // Color based on theme
        const r = Math.round(waveStart[0] + (waveEnd[0] - waveStart[0]) * normalized);
        const g = Math.round(waveStart[1] + (waveEnd[1] - waveStart[1]) * normalized);
        const b = Math.round(waveStart[2] + (waveEnd[2] - waveStart[2]) * normalized);
        const color1 = `rgb(${r}, ${g}, ${b})`;
        const color2 = `rgb(${Math.min(r + 10, 255)}, ${Math.min(g + 10, 255)}, ${Math.min(b + 10, 255)})`;

        el.style.setProperty('--color-1', color1);
        el.style.setProperty('--color-2', color2);

        // Traveling wave effect for system-thinking state
        if (animationState === 'system-thinking') {
          const time = Date.now() / 1000;
          const waveSpeed = 0.25;
          const phase = (time * waveSpeed - (index / numSquares)) % 1;
          const opacity = 0.3 + 0.7 * Math.abs(Math.sin(phase * Math.PI * 2));
          el.style.opacity = opacity;
        } else {
          el.style.opacity = 1;
        }
      });

      requestAnimationFrame(animateVoice);
    }

    // Initialize waveform
    createWaveformSquares();
    animateVoice();
  </script>
</body>
</html>
